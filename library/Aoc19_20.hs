{-# Language TupleSections #-}
module Aoc19_20 where
import Grid
import Data.Char
import qualified Data.Map as M

data Portal = P Char Char InOut
  deriving (Eq, Ord, Show)

parseSpot m p '.'  = case spots of
  [a] -> POI a
  [] -> Passage
  where
    spots
      = [ P a b (inOut p)
        | step <- adjacent (0,0)
        , (Just a:Just b:_) <- pure (getSpots step)
        , isUpper a
        , isUpper b
        ]
    getSpots dir = fixOrder dir $ take 2 $ tail $ map (m M.!?) (iterate (plusPoint dir) p)
    isBackwards p = p `elem` [ (-1, 0), (0, -1) ]
    fixOrder p = if isBackwards p then reverse else id
parseSpot _ _ _ = Wall

graph dat = parseGrid  dat (parseSpot dat)


type Level = Int
data InOut = In | Out
  deriving (Show, Eq, Ord)
inOut (x,y)
    | max x y >= 100 || min x y <= 3 = Out
    | otherwise = In
solve1 = head $ filter ((P 'Z' 'Z' Out==).fst) $ dijkstra 0 (+) step (P 'A' 'A' Out)
  where
   step p@(P 'A' 'A' b) = neighborsG g p
   step p@(P 'Z' 'Z' b) = neighborsG g p
   step p@(P x y In) = (P x y Out, 1) : neighborsG g p
   step p@(P x y Out) = (P x y In, 1) : neighborsG g p
   g = graph dat1

solve2 = head $ filter ((== (P 'Z' 'Z' Out, 0)) . fst) $ aStar heuristic 0 (+) step (P 'A' 'A' Out, 0)
  where
   step :: (Portal, Int) -> [((Portal, Int), Int)]
   step (p, i) = case p of 
     P 'A' 'A' Out -> neighbors i p
     P 'Z' 'Z' Out -> neighbors i p
     P x y Out
       | i >= 1 -> ((P x y In, i-1),1) : neighbors i p
       | otherwise -> neighbors i p
     P x y In -> ((P x y Out, i+1),1) : neighbors i p
   neighbors i p = [((q,i), g M.! p M.! q) | q <-  M.keys (g M.! p)]
   g = M.map M.fromList $ unGraph $ graph dat1
   heuristic (P _ _ _, b) = max 0 (b) * 42


-- 125 * 129
dat1 = indexGrid
   ["                                       Z   R     J       K       A A   P           H                                         ",
    "                                       Z   X     Y       V       O A   W           Y                                         ",
    "  #####################################.###.#####.#######.#######.#.###.###########.#######################################  ",
    "  #.......#.#.#...#.#.#.......#.#.........#...#.#.....#...#...#.....#.........#...................#.....#...#...#.#.#.#...#  ",
    "  #######.#.#.#.###.#.#.#####.#.#.#####.#.#.###.#####.#.###.#.#.###########.#.#.###.#######.#####.#.###.###.###.#.#.#.#.###  ",
    "  #...#.#.#.........#.....#.........#...#...#.........#.....#.#.......#.....#.#.#.#.#.#.#.#.#...#...#.#.#...........#.....#  ",
    "  #.###.#.#.#######.#.#######.###.#####.#####.#.###.###.#.###.#######.#.#######.#.###.#.#.#.#.###.#.#.###.#######.###.#####  ",
    "  #...#...#.#.........#.........#.#.#.......#.#...#.#...#.#...#.......#.......#.....#...#.......#.#...........#...........#  ",
    "  #.#.#.#########.#######.###.#####.###.###.###.###.###.#####.#.###.###.#####.###.###.#####.#.#######.###.#######.###.#####  ",
    "  #.#.....#.........#.....#.....#.....#.#...#...#...#.#.#.#...#...#...#.#.....#.........#...#...#.#.....#.#.#...#.#.....#.#  ",
    "  ###.#########.#.#######.#########.#######.#.#.###.#.###.###.###.###.#####.#.#.#####.#####.#.###.###.#####.#.###.#####.#.#  ",
    "  #.....#...#...#...#.#.......#.#.#.......#.#.#.#.#.#.........#.....#.#.#...#.#.....#.#...#.#...#.#.............#...#...#.#  ",
    "  ###.#####.#.#######.###.#####.#.###.#.#.#.###.#.###.###.#.###.#.#####.#.#######.#####.#####.###.###.#.#####.#.#########.#  ",
    "  #...#.#.........#.#...#...#.........#.#.....#...#.#.#...#.#...#.#...#.......#...#.....#.#.........#.#...#.#.#...#.#.#.#.#  ",
    "  ###.#.###.#.#####.###.#.#############.###.#####.#.###.###.###.#####.#.#.###.#.###.#.#.#.#.#.###.###.#####.#.#.###.#.#.#.#  ",
    "  #.....#.#.#.#.#.....#...#.#...#...#.#...#...#.....#.....#.#.....#.....#.#...#.....#.#.#.#.#.#.....#.....#.#.#...#.#.....#  ",
    "  ###.#.#.#####.#####.#####.#.#####.#.#.###.#####.#.#####.#####.###########.#.###.#.#.###.#####.#.#.#######.#######.#.#####  ",
    "  #.#.#.......#.#.#...#.....#.#...........#.#.#...#.#.....#.#.#...#...#.....#.#...#.#.#.#.....#.#.#...#.#...#...#.....#...#  ",
    "  #.###.#######.#.###.###.###.#########.#####.#.#######.#.#.#.#.###.#########.#######.#.#.###########.#.###.###.#####.#.###  ",
    "  #.#...#.#.#.............................#...#.....#...#.....#.......#.#.....#...............#...#.#.#...#.#.#.....#.#.#.#  ",
    "  #.###.#.#.#####.#####.#.###.#.#########.#.###.#.#####.#######.#.#.#.#.#####.#######.#.###.#.#.###.###.###.#.###.###.#.#.#  ",
    "  #...#.....#.#...#...#.#...#.#.#.#.#.#...#...#.#.#.#...#.#.#.#.#.#.#.#.#.#.#...#.....#.#.#.#.#.#...#...........#.........#  ",
    "  ###.#.#####.#####.###########.#.#.#.###.#.#.#.###.###.#.#.#.#.#######.#.#.#.#######.###.###.#.###.#.#.###.#####.#.#.#.###  ",
    "  #.....#.#.#.#.#.....#...#.....#.........#.#.#.......#...#...#.......#.........#...#.....#.#.#.#...#.#.#...#.#.#.#.#.#...#  ",
    "  #####.#.#.#.#.###.#####.#########.#####.#.#.#####.###.#.#.#.#.###.#.###.#.#######.#.#####.###.###.###.###.#.#.###.###.###  ",
    "  #.....#...#...#...#.....#.#.#.#...#.......#.#...#...#.#...#.#...#.#.#...#.#.....#.....#.#.#.........#.#.........#.#...#.#  ",
    "  #.#.#.#.###.#####.#####.#.#.#.#############.#.#.#.#########.#.###########.#.#.#.###.###.#.#.#####.#.#.#####.#.###.#####.#  ",
    "  #.#.#...#.#.......#.....#...........#.#...#.#.#.#...#.....#.#.#...#...#...#.#.#.#...............#.#.#.#.#...#.....#.#.#.#  ",
    "  #######.#.#######.###.###.#####.###.#.#.#.#.#.#.###.###.#.#.#.###.#.#####.###.#####.#.#############.###.#######.#.#.#.#.#  ",
    "  #.........#.#.#.......#.#.#...#.#.#.....#.#.#.#...#.#...#...#.......#.......#.......#.#...#...#...#.#.......#...#.....#.#  ",
    "  ###.###.###.#.###.###.#.#####.###.###.###.#.#.#.###.#.#############.###.#######.#######.###.###.#######.#########.#.###.#  ",
    "  #...#.....#.#.#.#.#...#.#...#.#.......#.#.#.#.#...#.#.#.....#.......#.......#...............#.....#...#.....#...#.#.#.#.#  ",
    "  #####.#.#.#.#.#.#####.#.#.#.#.#######.#.#.#.#.###.#.#.###.#.#.###########.#########.###.#.#.###.###.###.###.#.#####.#.#.#  ",
    "  #.#.#.#.#...#.......#.#.#.#.....#.......#...#...#.#.#.....#.#.#...#.........#.....#...#.#.#.#.#.#.#...#.#.....#.........#  ",
    "  #.#.#####.#.###.#####.#.#####.#.###.###.#.#####.#.#.#.###.#.#.#.#.###.#####.#.###.#.#.#.#.###.#.#.#.#######.#######.#####  ",
    "  #.#.....#.#.#.#.#...#.....#...#.....#...#...#...#...#...#.#.#...#...#.#.....#...#...#.#.#...#.#.......#.#.....#...#.#...#  ",
    "  #.#.###.###.#.#.#.#.#####.#####.#.#####.#####.#############.#####.#######.#####.#######.#####.#####.###.#.###.#.###.#.###  ",
    "  #.#.#.....#.#.....#.#...#...#.#.#.#    W     Q             T     J       Q     Y      #.#.#...#...#.#.#.#.#.....#...#.#.#  ",
    "  #.#####.###.###.#####.###.###.#####    S     D             T     Y       E     V      ###.###.#.#.#.#.#.###.###.###.#.#.#  ",
    "  #.#.#.......#.#.#...#.......#.#.#.#                                                   #.#.#...#.#.......#...#...........#  ",
    "  #.#.#######.#.#.#.#######.###.#.#.#                                                   #.#.#.#.###.#############.###.###.#  ",
    "  #.#.#...#.....#...#.......#.#......TG                                                 #...#.#.#.....#.....#.......#.#.#..UO",
    "  #.#.#.#.###.###.#######.#.#.###.###                                                   #.#####.###.#######.#.###.#####.###  ",
    "  #...#.#.#...#.....#.#...#.#.#.....#                                                 LS..#.....#.....#.#.#.#...#...#...#.#  ",
    "  #.#####.#.#####.###.###.###.#.#.###                                                   #.###.#####.###.#.#.###.#.#.###.#.#  ",
    "  #.#.#.#.#.....#.#...#.....#...#...#                                                   #.......................#.#.#.....#  ",
    "  #.#.#.#.#.###.#.###.#.###.#.###.###                                                   #.#############################.###  ",
    "VN..........#.#.........#.#.....#...#                                                   #.#.#.#...........................#  ",
    "  #########.#.#####.#####.#########.#                                                   ###.#.#.#########.#####.#.#.#####.#  ",
    "  #.......#.#.....#.#...........#.#.#                                                 WJ..#...........#...#.#.#.#.#.#......BU",
    "  #.#.#######.#.#####.###.#.#####.###                                                   #.#####.#######.###.#.#####.#.#####  ",
    "IV..#.........#.......#.#.#..........UO                                                 #.........#...#.#...#...#...#.#.#.#  ",
    "  #####.###############.#############                                                   ###########.#####.#.#.###.#####.#.#  ",
    "TG....#.#...................#.......#                                                 LD..#.....#.......#.#.....#.#........QE",
    "  #.#####.#.###.#.###.###.#####.#.###                                                   #.#.###.#.#####.#####.#######.#.#.#  ",
    "  #...#.#.#...#.#...#.#.........#...#                                                   #.#...#...#.....#.......#...#.#.#.#  ",
    "  #.###.###.###.#########.#.#.#.#.#.#                                                   #.###.#.###.###.#.#.#######.###.###  ",
    "  #...........#.#.#...#...#.#.#.#.#.#                                                   #.#...#.#...#...#.#.....#.#.#.#...#  ",
    "  ###.###.#######.#.###.#######.###.#                                                   #.#.#######.#######.#####.#.#.###.#  ",
    "  #...#.......#.#.....#...#...#.#.#..JM                                                 #...#.#.#.........................#  ",
    "  #.###########.###.#########.###.###                                                   #####.#.#################.#########  ",
    "  #...#.#.............#.#.......#...#                                                 AO........#.#.#.#.........#.#.......#  ",
    "  #####.#.###########.#.#####.#.#.#.#                                                   #.#.###.#.#.#.###.#.###.###.#####.#  ",
    "  #.#.#.#.........#...#.....#.#...#..LF                                                 #.#.#...#...#.....#.#.....#...#....UB",
    "  #.#.#.#######.#####.###.###.#####.#                                                   #.#.#.###.#.#.###.#####.#####.###.#  ",
    "  #...........#...#.......#.......#.#                                                   #.#.#.....#...#.#.#.#.#.........#.#  ",
    "  #.#####.#.###.###.#.#.#.#######.#.#                                                   #.###########.#.###.#.#############  ",
    "JM..#...#.#.....#.#.#.#.#.........#.#                                                   #.#.#.......#.#...#...#...........#  ",
    "  #.###.#######.#.###.###.###.#######                                                   ###.#.###.#.###.#.#.#.#.#########.#  ",
    "  #.#.....#...#...#.#.#.#.#.#...#...#                                                 UB....#.#...#.....#...#.#.........#.#  ",
    "  #####.#.#.#.#####.###.###.#.###.#.#                                                   #.###.#####.#.#.#####.#.#######.#.#  ",
    "WS....#.#.#.#.............#.#.#...#.#                                                   #.#.....#.#.#.#...#...#.#.....#.#.#  ",
    "  #.#.#.#.#.###.#.#.#######.#####.#.#                                                   #.###.###.#.#.#####.#####.###.#.#.#  ",
    "  #.#.#.#.#...#.#.#.#.#.#.#...#...#.#                                                   #.....#...#.#.#.#.#.........#...#..BM",
    "  ###.#.#.###.###.###.#.#.###.###.#.#                                                   #####.###.#####.#.#################  ",
    "  #.#...#.....#.#.................#..HY                                                 #.#...#.#...#.#...................#  ",
    "  #.###########.#####################                                                   #.###.#.#.#.#.#.###.###.#.#.#.###.#  ",
    "  #.....................#...........#                                                 BM....#.#...#.#...#.#.#...#.#.#.#...#  ",
    "  ###.#.#.#######.#.###.#.###.###.#.#                                                   #.#####.###.#.###.#############.###  ",
    "FM....#.#.#...#...#.#.......#.#...#.#                                                   #.#.#.#.#...#.......#...#.......#.#  ",
    "  ###.#####.#####.###.#############.#                                                   #.#.#.#.#.#####.#####.#######.###.#  ",
    "  #.#.#.#.......#.#.#.#...#.#.#.#....PW                                                 #.......#.............#.#..........TT",
    "  #.###.#.#########.###.###.#.#.#####                                                   ###.#############.#.###.###########  ",
    "  #...#.....#.......................#                                                   #.#.#...#.....#.#.#.#.....#...#....WJ",
    "  #.#.#.#.#####.###.#.#######.#######                                                   #.###.#.#.###.#.#######.#.#.#####.#  ",
    "  #.#.#.#...#...#...#.#.......#.....#                                                 RX..#...#...#.......#...#.#...#.#...#  ",
    "  #.#.#.#.#.###.#########.#######.###                                                   #.###.#####.#####.#.#.#####.#.###.#  ",
    "  #.#...#.#.#.#.......#.........#....GP                                                 #.#.#.....#.....#.#.#...#...#.....#  ",
    "  #.#.###.###.#.###.#######.#.#.#.#.#                                                   #.#.#####.#####.#####.#.#.#.#.#####  ",
    "LS..#.#...........#.#.#.#.#.#.#...#.#                                                   #.........#.#.........#...#.....#.#  ",
    "  #.#####.###.#.#.###.#.#.#####.#####      K V       F       B       A   Y       I      #.#.###.#.#.###.###.#.#.#.#.#.###.#  ",
    "  #.#.......#.#.#...#...............#      V N       M       U       N   D       V      #.#.#.#.#...#.....#.#.#.#.#.#...#.#  ",
    "  #######.###############.###.#############.#.#######.#######.#######.###.#######.#######.###.#######.###.###.#######.###.#  ",
    "  #.#.......#.........#...#.#.#...#...........#.........#...#...#.#...#.......#...#.....#.#...#.#.#...#...#.#.....#.......#  ",
    "  #.#####.#.#####.#####.###.#.#.###.#######.#.#.#.###.#####.#.###.###.#.#.###.#.###.#.#####.###.#.###.#.###.#.###.#####.###  ",
    "  #.......#...........#...#.......#.#.#.....#.#.#...#.#.......#...#.#.#.#.#...#.....#...............#.#.#...#...#.#.....#.#  ",
    "  #.#.###.#.#.###.#.###########.#####.###.#.###.#.#####.###.#####.#.#.###.###.#####.#.#######.#.###.#######.#.#########.#.#  ",
    "  #.#.#...#.#...#.#...#.#.#.....#...#.....#...#.#...#...#.......#.....#...#...#...#.#.#.#...#.#.#.......#.............#...#  ",
    "  #######.#.#.#####.#.#.#.###.#####.#.#######.#.#############.#######.###.###.#.#.###.#.#.#########.#.###.#.#.###.#####.#.#  ",
    "  #.#.#.#.#.#.#.....#...#...#.#.....#.#.#.#...#...#...#.#.#.....#...#.#.#.#...#.#.#...............#.#.#...#.#.#...#.....#.#  ",
    "  #.#.#.#.#.#####.#####.###.#######.###.#.#.###.###.###.#.###.#.###.#.#.#####.#.#.#.###.#####.###.#.#####.###.#.#.#.###.###  ",
    "  #.......#.#...#.#.......#.#.#.#.....#.....#.#.#...#.........#.#.#.......#...#.#.....#.....#...#.#.....#...#.#.#.#...#...#  ",
    "  #.#.#.###.###.#.###.#.#.#.#.#.###.###.#####.#.#.#.#######.#####.#.###.#.#.#.#.#.#.#.###.#.#.#.###.#.#.#.###.#####.###.###  ",
    "  #.#.#.#...#.#...#...#.#.#...............#...#...#.......#.......#...#.#.#.#.#.#.#.#.#...#.#.#...#.#.#.#.#.#.#.#.....#...#  ",
    "  #.#####.#.#.#.#########.#.#.#.#.#.#.#.#.#.#.###.###.#.#.###.#.#####.###.###.#.#########.#.###.#.###.###.#.#.#.#.#.#.#.#.#  ",
    "  #...#...#.#...#.........#.#.#.#.#.#.#.#...#.#.#.#.#.#.#.#...#.#.....#.#.#.#.#.....#.#.#.#...#.#.#.#.#...#.....#.#.#.#.#.#  ",
    "  #.#####.###.#.#####.#.#.###.#.#####.#####.#.#.###.#.#####.###.###.#.#.###.#.#.#####.#.###########.#.###.#.###.#####.#.###  ",
    "  #...#...#...#.....#.#.#.#...#.#.#...#.....#.....#...#.......#.#...#.....#...#.#...#.......#.#...#.#.#...#...#.#...#.#...#  ",
    "  #.###.#.###.#.#####.#######.#.#.#.#.#######.#####.###.###.#######.#.#.#####.#.###.###.#####.#.###.#######.###.#.#.###.###  ",
    "  #.#...#.#...#...#...#.....#.#.#...#.#.......#.....#.#.#.......#...#.#...#.#.#.....#.....#.......#.....#...#.#.#.#.......#  ",
    "  #.#.#.###.#########.###.#####.###.#.#####.#####.#.#.#######.#####.#######.#.#.#######.###.#######.#.#######.#.###.#.###.#  ",
    "  #.#.#.#.......#.....#.#.#.#...#.#.#.#.........#.#...#.#...#.#.......#...#.#.#.#.#.....#.#.........#.#.#.......#.#.#.#...#  ",
    "  #######.#.#.#####.#.#.#.#.###.#.###########.#####.###.#.###.#.#######.###.#.#.#.#####.#.#.###########.#####.#.#.#.###.###  ",
    "  #.......#.#...#.#.#.#.#...#...#.#.#...#.#.#...#.....#.......#.#.....#.......#.#...#...#...........#.#.#.#.#.#.#.#.#.....#  ",
    "  #########.#.#.#.#####.###.#####.#.###.#.#.#.###.###.###.#####.#.#.#.#.#######.#.###.#.#.#.#.###.###.#.#.#.#.###.#.#####.#  ",
    "  #...#.#...#.#.#...#.............#...#.#.#...#.#.#.....#.#...#.#.#.#.#.....#.#.....#.#...#.#...#.#.#...#...#...#.#.#.#...#  ",
    "  ###.#.###.#.#.#.#.###.#.#.#.###.###.#.#.###.#.###.#.#.#.#.#.#.###.#.###.#.#.###.#####.###########.###.###.#####.###.#.#.#  ",
    "  #.........#.#.#.#.....#.#.#.#.#.............#.....#.#.#...#.#.....#...#.#.#.......................#.#...............#.#.#  ",
    "  #.#####.#.#########.###.#.###.#.#.#.#.#####.###.#.#########.#.#####.#####.#####.###.###.#####.#.###.#.#####.#####.#.#.#.#  ",
    "  #...#...#.#...........#.#.#.....#.#.#.#.......#.#...#.....#.#.#...#.#.#...#.#...#.....#.#.#.#.#.........#.....#.#.#.#.#.#  ",
    "  #.#.#######.#.#.#.#.###.###.###.#.#########.#######.###.#.#.###.#.#.#.#.###.#####.#.#.###.#.###.#.#####.###.###.#.#####.#  ",
    "  #.#...#.#...#.#.#.#.#...#...#...#...#...#.#...#.....#...#...#...#...#...........#.#.#.........#.#...#.#...#.#.#.....#...#  ",
    "  #.#.###.###.###.#####.#.#########.#.#.#.#.#.#####.###.#.###.#.#########.###.#####.#######.#.#######.#.#.#####.###.#####.#  ",
    "  #.#...#.#.....#...#...#...#.......#.#.#.....#...#...#.#...#.#.#.......#.#...#.....#.#.....#.#.#...#...#.......#.....#...#  ",
    "  #.#####.###.#.#.#.#.#.#.#####.#.#.#####.###.#.#.###.#.#######.#.###.#######.#####.#.#####.###.#.###.#.#.#.###.###.#.#####  ",
    "  #...#.......#.#.#.#.#.#...#...#.#...#...#...#.#.....#.....#.....#.....#.......#.........#.........#.#.#.#...#...#.#.....#  ",
    "  #########################################.#.#.#########.#########.#########.###.#########################################  ",
    "                                           A G Y         L         Q         L   Y                                           ",
    "                                           N P V         F         D         D   D                                           "]
