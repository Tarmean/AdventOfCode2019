{-# Language ScopedTypeVariables #-}
module Aoc19_18 where
import qualified Data.Set as S
import qualified Data.IntSet as I
import qualified Data.Map.Strict as M
import Data.Char
import Grid hiding (Spot)
import Control.Applicative
import Data.Functor.Compose
import Data.Monoid

main = do
  mapM_ print $  solve dat1
  -- mapM_ print $ solve dat2

replaceOne :: forall a r. [a] -> (a -> (a -> [a]) -> r) -> [r]
replaceOne xs cont = go id xs
  where
    go :: ([a] -> [a]) -> [a] -> [r]
    go p (x:xs) = cont x (p . (:xs)) : go ((x:) . p) xs
    go _ [] = []
data Spot = Key Char | Lock Char | Start (Int, Int)
  deriving (Eq, Ord, Show)
parseSpot _ '#' = Wall
parseSpot _ '.' = Passage
parseSpot i '@' = POI (Start i)
parseSpot _ c
  | isLower c = POI (Key c)
  | isUpper c = POI (Lock c)
  
toState :: Graph Spot -> (S.Set Spot, I.IntSet)
toState graph = (S.fromList [Start p | Start p <- M.keys (unGraph graph)], I.empty)

type Key = Char
metaSearch :: Graph Spot -> M.Map Spot [(Key, Int, I.IntSet)] 
metaSearch graph = M.fromList [(a, helper a) | a <- M.keys (unGraph graph), isSource a]
  where
    isSource (Lock _) = False
    isSource _ = True
    helper p = concatMap flatten $ dijkstra (0, I.empty) mergeCost step p
    flatten (Key c, (cost, locks)) = [(c, cost, locks)]
    flatten _ = []
    step a = [(a', (cost, getKey a)) | (a', cost) <- neighborsG graph a]
    getKey (Lock c) = I.singleton (fromEnum c)
    getKey _ = I.empty
    mergeCost (i, s) (j, t) = (i+j, s <> t)
solve inp = filter isDone $ dijkstra 0 (+) step startState
  where
    metaTable = metaSearch graph

    minDist = minimum $ map (\(_, c, _) -> c) (concat $ M.elems $ metaTable)
    heuristic (bots, keys) = (keyCount - I.size keys) * minDist

    isDone = ((>= 12) . I.size . snd . fst)
    keyCount = length [ a  | Key a <- M.keys (unGraph graph)]
    graph = parseGrid inp parseSpot
    startState = toState graph

    step :: (S.Set Spot, I.IntSet) -> [((S.Set Spot, I.IntSet), Int)]
    step (bots,keys)
        = concat $ replaceOne (S.toList bots) $ \bot cont ->
        [((S.fromList (cont (Key key)),keys'), cost)
        | (key, cost, reqKeys) <- metaTable M.! bot
        -- , reqKeys `S.isSubsetOf` keys
        , let keys' = I.insert (fromEnum $ toUpper key) keys
        ]
    -- reachable keys (Lock c)
    --   | S.member (toLower c) keys = pure keys
    --   | otherwise = mempty
    -- reachable keys (Key c) = pure (S.insert c keys)
    -- reachable keys (Start _) = pure keys



dat2 = indexGrid
    ["#################################################################################",
    "#.....#.#...#...........Z...........#...#.......#...#...........#.........#.....#",
    "#.###.#.#.#.#.###########.#########.###.#.#####.#.#.#.#.#######.#####.###.#.###.#",
    "#.#.....#.#.#.#b#.......#...#...#.#...#.#.#...#...#.#.#...#...#...#...#.#.#...#.#",
    "#M#######.#.#.#.#.###.#####.#.#.#.###.#.#.###.#####.#.###.#.#.###.#.###.#.###.#.#",
    "#.........#.#.#.#...#.....#.#.#.....#.#.#...#.....#.....#.#.#...#...#.....#...#.#",
    "#.#########.#.#.###.#####.#.#.#####.#.#.###.#.###.#######.#.###.#####.#####.###.#",
    "#...#.....#...#.....#.....#.#.....#.#...#.#.#.#.....#...#.#.#.#.....#.....#.#.#.#",
    "###.###.#.###########.###.#.#####.#####.#.#.#.#######.#.#.#.#.###.#######.#.#.#.#",
    "#...#.T.#.#...........#...#.....#.......#.#.#...#.....#...#.#...#.......#...#.#.#",
    "#.###.###.#.###########.#######.###.#####.#.###.#.#########.###.#######.#####.#.#",
    "#.....#.#.#.#.........#.#.....#...#.#...#.......#...#.....#.#.........#i....#...#",
    "#######.#.#.#.#######.#.#.###.###.#.#.#.###########.#.###.#.#.#######.###.###.###",
    "#.#.....#.#.#...#.....#.#.#.#.#...#.#.#.#.........#.#.#.#...#.....#.#.#...#...#.#",
    "#.#.#.###.#V###.#.#######.#.#.#.###.#.#.#.#######.#.#.#.#########.#.#.#.###.###.#",
    "#...#.......#.#.#.....#...#...#.#...#.#.#a#.........#.........#...#.#.#.....#...#",
    "###########.#.#.#####.#.###.###.#.#####.#.###################.#.###.#.#######.###",
    "#.....#...#.#.#.#...#.#.#.#...#.#...#...#.#.....#...........#.#...#.#.#........e#",
    "#.###.#.#.#.#.#.#.#.#.#.#.###.#.###.#.#.#.#.###.#######.#.###.###.#.#.#########.#",
    "#...#...#.#...#.#.#.....#...#.#.#.....#.#.#.#.#.......#.#.........#.....#.......#",
    "###.#####.###.#.#########.#.#.#.#######.#.#.#.#######.#.###############.#.#######",
    "#.#.#.....#...#.....#.#...#.#.#.......#.#.#...#...#...#.#...#.#.....#..w#.#.....#",
    "#.#.#.#############.#.#.###.#.#####.#.###Q###.#.#.#.###.###.#.#.###.#.###.#.###.#",
    "#.#.#.............#...#.#...#.....#.#...#.....#.#...#.......#.#.#...#.....#.#.#.#",
    "#.#.#############.#####.#.#######.#.###.#.#####.###.#######.#.#.###.###.###.#.#.#",
    "#.#.#.........#.#.......#.#.......#...#.#.#...#.#...#.....#.#.#...#...#.#...#.#.#",
    "#.#.#.#.#####.#.###.#####.#.###########.#.###.#.#####.###.#.#.#.#.###.###.###.#.#",
    "#.#.#.#.#x..#...#.#.#...#.#...#.........#.....#.#.....#.#.#.#.#.#...#s..#.#.#...#",
    "#.#.#.###.#.###.#.#.#.#.#####.#.#.#.#####.#####.#.#####.#.###.#####.###.#.#.#.###",
    "#.#.#...#.#...#...#...#.......#.#.#.#...#.#.....#.....#.#...#.......#.#...#.#...#",
    "#.#.#.#.#.###.###################.###.#.#.#.###.#####.#.###.#########.#####.###.#",
    "#...#.#...#.#.............#.....#...#.#.#.#.#.....#...#...#...#.......#.....#...#",
    "#.###.#####.#######.#####.###.#.#.#.#.#.#.#.#.#####.###.#.#.###.#.###.#.###.#.###",
    "#...#.......#...#...#.#.C.#...#.#.#...#.#.#.#.#...#...#.#.#.....#.#...#.#...#.#.#",
    "###.#######.###.#.###.#.###.###.#######.#.#.###.#.###.#.#.#######.#.###.#####.#.#",
    "#.#...#.....#...#.#.....#.....#...#...#.#.#...#.#.....#.#...#...#.#.#...#...#...#",
    "#.###.#.#####.#.#.###.#######.###.#.#.#.#.###.#.#######.###.#.#.#.#.#.###.#.###.#",
    "#...#.#.......#.#...#...#...#.#...#.#...#...#.#.#...#...#.#.#.#.#.#...#...#...#.#",
    "#.#.#.#############.###.#.#.#.#.###.###.###.#.#.#.#.###.#.#.###.#.#####.###.###.#",
    "#.#.................#.....#...#.....#..@#@..#.....#.....#.......#.........#.....#",
    "#################################################################################",
    "#h#.......#.#...........#.......#.#....@#@..........#.......#......c....#.#.....#",
    "#.#.###.#.#.#.#####.###.#.#####F#.#.#.#####.###.#####.#.#####.#.#######.#.#.#.#.#",
    "#.#...#.#...#l..J.#.#.L.#.#.#...#...#...#...#...#.....#.......#.#.....#...#.#.#.#",
    "#O###.#.#########.#.#####.#.#.#########.#.#######.#############.#.###.#####.#.###",
    "#.#...#....j..#...#.....#f..#.#.........#q#.....#...#...#.....#.#.#.#.......#...#",
    "#.#.#######.###.#######.#.###.#.#######.#.#.###.###.#.#.#####.#.#.#.#########.#.#",
    "#.#.#.....#...#.#.....#...#..k#.#.....#.#...#.#.....#.#.....#.#...#.#...#...#.#.#",
    "#.#.#.###.###.#.###.#######.###.###.#.#.#.###.#######.#####.#.#####.#.#.#.#.###.#",
    "#.#.#...#...#...#...#.......#.....#.#...#.....#.......#.......#.....#.#...#.#...#",
    "#.#.###.###.#####.#.#K###########.###.#######.#.#####.#######.###.###.#####.#.###",
    "#.#.#...#.#...#...#.#....d#.....#...#...#...#.#.#...#.....#.#.#...#...#...#.#...#",
    "#.#.#.###.###.###.#######.#.###D###.#####.#.#.###.#.#.###.#.#.#.#.#.#####.#.###.#",
    "#...#...#...#...#.#.....#.....#...#.....#.#.#.....#.#...#.#..u..#.#.#...#.....X.#",
    "#.###.#.#.#####.#.#.###P###.#####.#####.#.#########.###.#.#########.#.#.#######.#",
    "#.#.E.#.#.........#g#.#...#.#...#...#...#.........#.#...#.#.......#...#...#v..#.#",
    "#.#####.#H#########.#.###.#.#.#.###.#.###.#.#######.#.###.#.#####.#.#####.#.#.###",
    "#..o..#.#.#.....#...#p....#.#.#..y..#...#.#.#.....#.#...#.#.....#.#.#...#...#...#",
    "#####.#.###.###.#.###.#######.#########.###.#.###.#.#####.#####.#.#.#.#.#######.#",
    "#.....#...#...#.#...#.......Y.#.......#.#...#...#.#...#...#.#...#.#.#.#.....#...#",
    "#.#######.#.###.###.###########.#####.#.#.#####.#.###.#.#.#.#.###.#.#.#####.#.###",
    "#...#...#...#.....#.#...#...........#...#.#.....#.#...#.#...#.#.#.#.#.....#...#.#",
    "###.#.#.#####.###.#.###.###########.###.#.#.#####.#.###.###.###.#.#.#####.#####.#",
    "#.#...#.W.....#...#...#.#.........#...#.#...#.....#.#.#...#...B.#.#.#.#...#.....#",
    "#.#############.###G###N#.#######.#.#.#.#####.#####A#.#.#.#####.#.#.#.#.###.#####",
    "#.....R...#.U.#.#...#...#.#..m..#.#.#.#.#.....#.....#.#.#...#...#.#...#..r#.....#",
    "#.###.#####.#.#.#.###.###.#.###.#.#.#.###.###.#.#####.#.###.###.#.#######.#.###.#",
    "#.#...#...#.#...#..n..#...#...#.#.#z#...#.#.#.#.....#.....#...#.#.......#.#.#...#",
    "###.###.#.#.#############.#.#.###.#####.#.#.#.#####.#########.#.#######.#.#.#.###",
    "#...#...#...#.......#.....#.#...#.......#.#.......#.......#...#.....#.#...#.#...#",
    "#.###.#######.#####.#.#########.#######.#.#######.#######.#.#######.#.#####.###.#",
    "#...#.#.....#.....#.#...#.....#...#...#.#...#.....#.....#.#.......#.....#...#...#",
    "#.#.#S#.###.#####.#.#.#.#.###.###.#.#.#.#.#.#.#######.###.#.#####.#####.#.###.#.#",
    "#.#.#.#.#.#.......#.#.#...#.#...#...#...#.#.#...#.....#...#.....#.....#.#.#...#.#",
    "###.#.#.#.#########.#.#####.###.#.#########.###.###.###.#######.#####.###.#.###.#",
    "#.I.#.#.#.....#...#.#.........#.#...#...#...#.#.....#...#...#...#...#.....#.#.#.#",
    "#.#.#.#.#.#.###.#.#.###########.###.###.#.###.#.#####.###.#.###.#.#.#######.#.#.#",
    "#.#.#...#.#.....#...#.........#...#.....#.#.....#.....#...#...#.#.#.....#...#...#",
    "#.#######.###########.#######.###.#####.#.#######.#####.#####.###.#####.#.###.###",
    "#.....................#...........#.....#...............#.........#....t..#.....#",
    "#################################################################################"]
dat1 = indexGrid [
    "#################################################################################",
    "#.....#.#...#...........Z...........#...#.......#...#...........#.........#.....#",
    "#.###.#.#.#.#.###########.#########.###.#.#####.#.#.#.#.#######.#####.###.#.###.#",
    "#.#.....#.#.#.#b#.......#...#...#.#...#.#.#...#...#.#.#...#...#...#...#.#.#...#.#",
    "#M#######.#.#.#.#.###.#####.#.#.#.###.#.#.###.#####.#.###.#.#.###.#.###.#.###.#.#",
    "#.........#.#.#.#...#.....#.#.#.....#.#.#...#.....#.....#.#.#...#...#.....#...#.#",
    "#.#########.#.#.###.#####.#.#.#####.#.#.###.#.###.#######.#.###.#####.#####.###.#",
    "#...#.....#...#.....#.....#.#.....#.#...#.#.#.#.....#...#.#.#.#.....#.....#.#.#.#",
    "###.###.#.###########.###.#.#####.#####.#.#.#.#######.#.#.#.#.###.#######.#.#.#.#",
    "#...#.T.#.#...........#...#.....#.......#.#.#...#.....#...#.#...#.......#...#.#.#",
    "#.###.###.#.###########.#######.###.#####.#.###.#.#########.###.#######.#####.#.#",
    "#.....#.#.#.#.........#.#.....#...#.#...#.......#...#.....#.#.........#i....#...#",
    "#######.#.#.#.#######.#.#.###.###.#.#.#.###########.#.###.#.#.#######.###.###.###",
    "#.#.....#.#.#...#.....#.#.#.#.#...#.#.#.#.........#.#.#.#...#.....#.#.#...#...#.#",
    "#.#.#.###.#V###.#.#######.#.#.#.###.#.#.#.#######.#.#.#.#########.#.#.#.###.###.#",
    "#...#.......#.#.#.....#...#...#.#...#.#.#a#.........#.........#...#.#.#.....#...#",
    "###########.#.#.#####.#.###.###.#.#####.#.###################.#.###.#.#######.###",
    "#.....#...#.#.#.#...#.#.#.#...#.#...#...#.#.....#...........#.#...#.#.#........e#",
    "#.###.#.#.#.#.#.#.#.#.#.#.###.#.###.#.#.#.#.###.#######.#.###.###.#.#.#########.#",
    "#...#...#.#...#.#.#.....#...#.#.#.....#.#.#.#.#.......#.#.........#.....#.......#",
    "###.#####.###.#.#########.#.#.#.#######.#.#.#.#######.#.###############.#.#######",
    "#.#.#.....#...#.....#.#...#.#.#.......#.#.#...#...#...#.#...#.#.....#..w#.#.....#",
    "#.#.#.#############.#.#.###.#.#####.#.###Q###.#.#.#.###.###.#.#.###.#.###.#.###.#",
    "#.#.#.............#...#.#...#.....#.#...#.....#.#...#.......#.#.#...#.....#.#.#.#",
    "#.#.#############.#####.#.#######.#.###.#.#####.###.#######.#.#.###.###.###.#.#.#",
    "#.#.#.........#.#.......#.#.......#...#.#.#...#.#...#.....#.#.#...#...#.#...#.#.#",
    "#.#.#.#.#####.#.###.#####.#.###########.#.###.#.#####.###.#.#.#.#.###.###.###.#.#",
    "#.#.#.#.#x..#...#.#.#...#.#...#.........#.....#.#.....#.#.#.#.#.#...#s..#.#.#...#",
    "#.#.#.###.#.###.#.#.#.#.#####.#.#.#.#####.#####.#.#####.#.###.#####.###.#.#.#.###",
    "#.#.#...#.#...#...#...#.......#.#.#.#...#.#.....#.....#.#...#.......#.#...#.#...#",
    "#.#.#.#.#.###.###################.###.#.#.#.###.#####.#.###.#########.#####.###.#",
    "#...#.#...#.#.............#.....#...#.#.#.#.#.....#...#...#...#.......#.....#...#",
    "#.###.#####.#######.#####.###.#.#.#.#.#.#.#.#.#####.###.#.#.###.#.###.#.###.#.###",
    "#...#.......#...#...#.#.C.#...#.#.#...#.#.#.#.#...#...#.#.#.....#.#...#.#...#.#.#",
    "###.#######.###.#.###.#.###.###.#######.#.#.###.#.###.#.#.#######.#.###.#####.#.#",
    "#.#...#.....#...#.#.....#.....#...#...#.#.#...#.#.....#.#...#...#.#.#...#...#...#",
    "#.###.#.#####.#.#.###.#######.###.#.#.#.#.###.#.#######.###.#.#.#.#.#.###.#.###.#",
    "#...#.#.......#.#...#...#...#.#...#.#...#...#.#.#...#...#.#.#.#.#.#...#...#...#.#",
    "#.#.#.#############.###.#.#.#.#.###.###.###.#.#.#.#.###.#.#.###.#.#####.###.###.#",
    "#.#.................#.....#...#.....#.......#.....#.....#.......#.........#.....#",
    "#######################################.@.#######################################",
    "#h#.......#.#...........#.......#.#.................#.......#......c....#.#.....#",
    "#.#.###.#.#.#.#####.###.#.#####F#.#.#.#####.###.#####.#.#####.#.#######.#.#.#.#.#",
    "#.#...#.#...#l..J.#.#.L.#.#.#...#...#...#...#...#.....#.......#.#.....#...#.#.#.#",
    "#O###.#.#########.#.#####.#.#.#########.#.#######.#############.#.###.#####.#.###",
    "#.#...#....j..#...#.....#f..#.#.........#q#.....#...#...#.....#.#.#.#.......#...#",
    "#.#.#######.###.#######.#.###.#.#######.#.#.###.###.#.#.#####.#.#.#.#########.#.#",
    "#.#.#.....#...#.#.....#...#..k#.#.....#.#...#.#.....#.#.....#.#...#.#...#...#.#.#",
    "#.#.#.###.###.#.###.#######.###.###.#.#.#.###.#######.#####.#.#####.#.#.#.#.###.#",
    "#.#.#...#...#...#...#.......#.....#.#...#.....#.......#.......#.....#.#...#.#...#",
    "#.#.###.###.#####.#.#K###########.###.#######.#.#####.#######.###.###.#####.#.###",
    "#.#.#...#.#...#...#.#....d#.....#...#...#...#.#.#...#.....#.#.#...#...#...#.#...#",
    "#.#.#.###.###.###.#######.#.###D###.#####.#.#.###.#.#.###.#.#.#.#.#.#####.#.###.#",
    "#...#...#...#...#.#.....#.....#...#.....#.#.#.....#.#...#.#..u..#.#.#...#.....X.#",
    "#.###.#.#.#####.#.#.###P###.#####.#####.#.#########.###.#.#########.#.#.#######.#",
    "#.#.E.#.#.........#g#.#...#.#...#...#...#.........#.#...#.#.......#...#...#v..#.#",
    "#.#####.#H#########.#.###.#.#.#.###.#.###.#.#######.#.###.#.#####.#.#####.#.#.###",
    "#..o..#.#.#.....#...#p....#.#.#..y..#...#.#.#.....#.#...#.#.....#.#.#...#...#...#",
    "#####.#.###.###.#.###.#######.#########.###.#.###.#.#####.#####.#.#.#.#.#######.#",
    "#.....#...#...#.#...#.......Y.#.......#.#...#...#.#...#...#.#...#.#.#.#.....#...#",
    "#.#######.#.###.###.###########.#####.#.#.#####.#.###.#.#.#.#.###.#.#.#####.#.###",
    "#...#...#...#.....#.#...#...........#...#.#.....#.#...#.#...#.#.#.#.#.....#...#.#",
    "###.#.#.#####.###.#.###.###########.###.#.#.#####.#.###.###.###.#.#.#####.#####.#",
    "#.#...#.W.....#...#...#.#.........#...#.#...#.....#.#.#...#...B.#.#.#.#...#.....#",
    "#.#############.###G###N#.#######.#.#.#.#####.#####A#.#.#.#####.#.#.#.#.###.#####",
    "#.....R...#.U.#.#...#...#.#..m..#.#.#.#.#.....#.....#.#.#...#...#.#...#..r#.....#",
    "#.###.#####.#.#.#.###.###.#.###.#.#.#.###.###.#.#####.#.###.###.#.#######.#.###.#",
    "#.#...#...#.#...#..n..#...#...#.#.#z#...#.#.#.#.....#.....#...#.#.......#.#.#...#",
    "###.###.#.#.#############.#.#.###.#####.#.#.#.#####.#########.#.#######.#.#.#.###",
    "#...#...#...#.......#.....#.#...#.......#.#.......#.......#...#.....#.#...#.#...#",
    "#.###.#######.#####.#.#########.#######.#.#######.#######.#.#######.#.#####.###.#",
    "#...#.#.....#.....#.#...#.....#...#...#.#...#.....#.....#.#.......#.....#...#...#",
    "#.#.#S#.###.#####.#.#.#.#.###.###.#.#.#.#.#.#.#######.###.#.#####.#####.#.###.#.#",
    "#.#.#.#.#.#.......#.#.#...#.#...#...#...#.#.#...#.....#...#.....#.....#.#.#...#.#",
    "###.#.#.#.#########.#.#####.###.#.#########.###.###.###.#######.#####.###.#.###.#",
    "#.I.#.#.#.....#...#.#.........#.#...#...#...#.#.....#...#...#...#...#.....#.#.#.#",
    "#.#.#.#.#.#.###.#.#.###########.###.###.#.###.#.#####.###.#.###.#.#.#######.#.#.#",
    "#.#.#...#.#.....#...#.........#...#.....#.#.....#.....#...#...#.#.#.....#...#...#",
    "#.#######.###########.#######.###.#####.#.#######.#####.#####.###.#####.#.###.###",
    "#.....................#...........#.....#...............#.........#....t..#.....#",
    "#################################################################################"]

